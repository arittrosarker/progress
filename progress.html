<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PoralAgbe - Study Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .bangla-text {
      font-family: 'Noto Serif Bengali', serif;
    }
  </style>
  <!-- Firebase JS SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex">
  <!-- Header -->
  <header class="w-full absolute top-0 left-0 z-50 flex items-center justify-center py-2 sm:py-4 pointer-events-none">
    <div class="bg-gray-900 bg-opacity-95 rounded-full px-4 sm:px-6 py-2 shadow flex items-center gap-2 sm:gap-3 pointer-events-auto border border-gray-200 text-wrap max-w-[90vw]">
      <span class="text-blue-400 text-lg sm:text-2xl font-bold">üìö</span>
      <span class="text-base sm:text-xl font-semibold tracking-wide">PoralAgbe Study Tracker</span>
    </div>
  </header>
  <!-- Mobile Sidebar -->
  <aside id="mobileSidebar" class="fixed inset-y-0 left-0 w-3/4 sm:w-64 max-w-[80vw] bg-gray-900 border-r border-gray-800 transform -translate-x-full transition-transform duration-200 ease-in-out z-50 shadow rounded-r-2xl">
    <div class="p-4 flex justify-between items-center border-b border-gray-600">
      <h2 class="text-base sm:text-lg font-semibold tracking-wide text-blue-400">Subjects</h2>
      <button onclick="toggleSidebar()" class="text-gray-400 hover:text-blue-400 transition text-lg sm:text-xl">‚úï</button>
    </div>
    <nav class="p-4 space-y-2"></nav>
  </aside>
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 hidden z-40 transition"></div>

  <!-- Main Wrapper -->
  <div class="flex-1 flex flex-col pt-16 sm:pt-20 w-full min-w-0">
    <!-- Top Bar: Subject Navigation & Add Chapter -->
    <nav class="bg-gray-900 bg-opacity-95 p-4 flex flex-wrap gap-2 justify-between items-center shadow rounded-b-2xl border-b border-gray-800">
      <div class="flex items-center space-x-2 flex-wrap">
        <button class="sm:hidden text-blue-400 text-xl sm:text-2xl transition hover:scale-110" onclick="toggleSidebar()">‚ò∞</button>
        <div id="subjectNav" class="hidden sm:flex sm:flex-wrap gap-2"></div>
        <button id="addChapterBtn" class="px-3 sm:px-4 py-1 sm:py-2 bg-blue-500 rounded-full text-xs sm:text-sm font-semibold text-white hover:bg-blue-600 shadow transition">+ Chapter</button>
      </div>
      <div class="flex items-center gap-1 sm:gap-2 flex-wrap">
        <button id="addSubjectBtn" class="px-2 sm:px-3 py-1 sm:py-2 bg-green-500 rounded-full text-xs font-semibold text-white hover:bg-green-600 shadow transition border border-green-700">+ Subject</button>
        <button id="removeSubjectBtn" class="px-2 sm:px-3 py-1 sm:py-2 bg-red-500 rounded-full text-xs font-semibold text-white hover:bg-red-600 shadow transition border border-red-700">- Subject</button>
        <div class="relative">
          <input id="universalSearch" type="text" placeholder="Search all chapters..." class="px-2 sm:px-3 py-1 sm:py-2 bg-gray-800 rounded-full text-xs font-semibold text-blue-400 hover:bg-blue-900 shadow transition border border-gray-700 w-32 sm:w-40 focus:outline-none" />
          <div id="universalSearchDropdown" class="absolute right-0 mt-2 w-48 sm:w-64 bg-gray-900 border border-blue-700 rounded shadow-lg hidden z-10 max-h-40 overflow-y-auto"></div>
        </div>
        <div class="relative">
          <button id="toolsBtn" class="px-2 sm:px-3 py-1 sm:py-2 bg-gray-800 rounded-full text-xs font-semibold text-blue-400 hover:bg-blue-900 shadow transition border border-gray-700 focus:outline-none">
            Tools ‚ñº
          </button>
          <div id="toolsDropdown" class="absolute right-0 mt-2 w-48 bg-gray-900 border border-blue-700 rounded shadow-lg hidden z-10">
            <button id="exportBtn" class="block w-full text-left px-4 py-2 text-xs hover:bg-blue-900">Export</button>
            <button id="importBtn" class="block w-full text-left px-4 py-2 text-xs hover:bg-blue-900">Import</button>
            <button id="themeToggleBtn" class="block w-full text-left px-4 py-2 text-xs hover:bg-blue-900">üåô/‚òÄÔ∏è</button>
            <button id="clearAllBtn" class="block w-full text-left px-4 py-2 text-xs hover:bg-red-900 text-red-400">Clear All</button>
            <button id="progressChartBtn" class="block w-full text-left px-4 py-2 text-xs hover:bg-purple-900 text-purple-400">Progress Chart</button>
            <button id="editStatusesBtn" class="block w-full text-left px-4 py-2 text-xs hover:bg-green-900 text-green-400">Edit Statuses</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Progress Bar -->
    <div id="progressBarWrapper" class="px-4 sm:px-6 pt-4 w-full"></div>

    <!-- Search -->
    <div class="px-4 sm:px-6 pt-2 flex flex-wrap gap-2 items-center w-full">
      <input id="chapterSearch" type="text" placeholder="Search chapters in current subject..." class="flex-1 px-3 py-2 rounded bg-gray-800 text-blue-400 placeholder-gray-500 focus:outline-blue-400 transition mb-2 w-full min-w-0" />
    </div>

    <!-- Chapters Grid -->
    <main id="chapterContainer" class="overflow-auto p-4 sm:p-6 grid gap-4 sm:gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 flex-1 w-full min-w-0"></main>
  </div>

  <script>
    const subjects = ['Bangla 1st','Bangla 2nd','English 1st','English 2nd','Physics 1st','Physics 2nd','Chemistry 1st','Chemistry 2nd','Biology 1st','Biology 2nd','Higher Math 1st','Higher Math 2nd','ICT'];
    let statusConfig = {
      'Physics 1st': ['Main Book','Parallel Text','Math Solving','MCQ','CQ','Concept Book','Eng QB','DU QB'],
      'Physics 2nd': ['Main Book','Parallel Text','Math Solving','MCQ','CQ','Concept Book','Eng QB','DU QB'],
      'Chemistry 1st': ['Main Book','Parallel Text','Math Solving','MCQ','CQ','Concept Book','Eng QB','DU QB'],
      'Chemistry 2nd': ['Main Book','Parallel Text','Math Solving','MCQ','CQ','Concept Book','Eng QB','DU QB'],
      'Higher Math 1st': ['Main Book','Parallel Text','Math Solving','MCQ','CQ','Concept Book','Eng QB','DU QB'],
      'Higher Math 2nd': ['Main Book','Parallel Text','Math Solving','MCQ','CQ','Concept Book','Eng QB','DU QB'],
      'Biology 1st': ['Main Book','Parallel Text','CQ','MCQ','DU QB'],
      'Biology 2nd': ['Main Book','Parallel Text','CQ','MCQ','DU QB'],
      'Bangla 1st': ['Main Book','Guide CQ','MCQ'],
      'Bangla 2nd': ['QNA','Board'],
      'English 1st': ['Reading','Word Meaning','Model Test'],
      'English 2nd': ['Read Rules','Model Test'],
      'ICT': ['Read Book','MCQ','CQ']
    };
    const classOptions = ['Telegram','College','Udvash Offline','Udvash Online','YouTube'];

    let state = {
      'Bangla 1st': [
        { title: '1. ‡¶¨‡¶æ‡¶ô‡ßç‡¶ó‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶®‡¶¨‡ßç‡¶Ø ‡¶≤‡ßá‡¶ñ‡¶ï', classMode: [], statuses: {} },
        { title: '2. ‡¶Ö‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶æ', classMode: [], statuses: {} },
        { title: '3. ‡¶∏‡¶æ‡¶π‡¶ø‡¶§‡ßç‡¶Ø‡ßá ‡¶ñ‡ßá‡¶≤‡¶æ', classMode: [], statuses: {} },
        { title: '4. ‡¶¨‡¶ø‡¶≤‡¶æ‡¶∏‡ßÄ', classMode: [], statuses: {} },
        { title: '5. ‡¶Ö‡¶∞‡ßç‡¶ß‡¶æ‡¶ô‡ßç‡¶ó‡ßÄ', classMode: [], statuses: {} },
        { title: '6. ‡¶Ø‡ßå‡¶¨‡¶®‡ßá‡¶∞ ‡¶ó‡¶æ‡¶®', classMode: [], statuses: {} },
        { title: '7. ‡¶ú‡ßÄ‡¶¨‡¶® ‡¶ì ‡¶¨‡ßÉ‡¶ï‡ßç‡¶∑', classMode: [], statuses: {} },
        { title: '8. ‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶æ‡¶¨‡ßÅ‡¶≤', classMode: [], statuses: {} },
        { title: '9. ‡¶Æ‡¶æ‡¶∏‡¶ø-‡¶™‡¶ø‡¶∏‡¶ø', classMode: [], statuses: {} },
        { title: '10. ‡¶ï‡¶™‡¶ø‡¶≤‡¶¶‡¶æ‡¶∏ ‡¶Æ‡ßÅ‡¶∞‡ßç‡¶Æ‡ßÅ‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶æ‡¶ú', classMode: [], statuses: {} },
        { title: '11. ‡¶∞‡ßá‡¶á‡¶®‡¶ï‡ßã‡¶ü', classMode: [], statuses: {} },
        { title: '12. ‡¶®‡ßá‡¶ï‡¶≤‡ßá‡¶∏', classMode: [], statuses: {} },
        { title: '13. ‡¶ã‡¶§‡ßÅ ‡¶¨‡¶∞‡ßç‡¶£‡¶®', classMode: [], statuses: {} },
        { title: '14. ‡¶¨‡¶ø‡¶≠‡ßÄ‡¶∑‡¶£‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶Æ‡ßá‡¶ò‡¶®‡¶æ‡¶¶', classMode: [], statuses: {} },
        { title: '15. ‡¶∏‡ßã‡¶®‡¶æ‡¶∞ ‡¶§‡¶∞‡ßÄ', classMode: [], statuses: {} },
        { title: '16. ‡¶¨‡¶ø‡¶¶‡ßç‡¶∞‡ßã‡¶π‡ßÄ', classMode: [], statuses: {} },
        { title: '17. ‡¶∏‡ßÅ‡¶ö‡ßá‡¶§‡¶®‡¶æ', classMode: [], statuses: {} },
        { title: '18. ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶æ‡¶®', classMode: [], statuses: {} },
        { title: '19. ‡¶§‡¶æ‡¶π‡¶æ‡¶∞‡ßá‡¶á ‡¶™‡ßú‡ßá ‡¶Æ‡¶®‡ßá', classMode: [], statuses: {} },
        { title: '20. ‡¶™‡¶¶‡ßç‡¶Æ‡¶æ', classMode: [], statuses: {} },
        { title: '21. ‡¶Ü‡¶†‡¶æ‡¶∞‡ßã ‡¶¨‡¶õ‡¶∞ ‡¶¨‡ßü‡¶∏', classMode: [], statuses: {} },
        { title: '22. ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø ‡ßß‡ßØ‡ß¨‡ßØ', classMode: [], statuses: {} },
        { title: '23. ‡¶Ü‡¶Æ‡¶ø ‡¶ï‡¶ø‡¶Ç‡¶¨‡¶¶‡¶®‡ßç‡¶§‡¶ø‡¶∞ ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶õ‡¶ø', classMode: [], statuses: {} },
        { title: '24. ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶≤‡¶ú‡ßç‡¶ú‡¶æ', classMode: [], statuses: {} },
        { title: '25. ‡¶®‡¶æ‡¶ü‡¶ï‡¶É ‡¶∏‡¶ø‡¶∞‡¶æ‡¶ú‡¶â‡¶¶‡ßç‡¶¶‡ßå‡¶≤‡¶æ', classMode: [], statuses: {} },
        { title: '26. ‡¶â‡¶™‡¶®‡ßç‡¶Ø‡¶æ‡¶∏‡¶É ‡¶≤‡¶æ‡¶≤‡¶∏‡¶æ‡¶≤‡ßÅ', classMode: [], statuses: {} }
      ],
      'Bangla 2nd': [],
      'English 1st': [],
      'English 2nd': [],
      'Physics 1st': [
        { title: '1. ‡¶≠‡ßå‡¶§ ‡¶ú‡¶ó‡¶§ ‡¶ì ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™', classMode: [], statuses: {} },
        { title: '2. ‡¶≠‡ßá‡¶ï‡ßç‡¶ü‡¶∞', classMode: [], statuses: {} },
        { title: '3. ‡¶ó‡¶§‡¶ø‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ', classMode: [], statuses: {} },
        { title: '4. ‡¶®‡¶ø‡¶â‡¶ü‡¶®‡¶ø‡ßü‡¶æ‡¶® ‡¶¨‡¶≤‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ', classMode: [], statuses: {} },
        { title: '5. ‡¶ï‡¶æ‡¶ú, ‡¶∂‡¶ï‡ßç‡¶§‡¶ø ‡¶ì ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ', classMode: [], statuses: {} },
        { title: '6. ‡¶Æ‡¶π‡¶æ‡¶ï‡¶∞‡ßç‡¶∑ ‡¶ì ‡¶Ö‡¶≠‡¶ø‡¶ï‡¶∞‡ßç‡¶∑', classMode: [], statuses: {} },
        { title: '7. ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡ßá‡¶∞ ‡¶ó‡¶æ‡¶†‡¶®‡¶ø‡¶ï ‡¶ß‡¶∞‡ßç‡¶Æ', classMode: [], statuses: {} },
        { title: '8. ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶¨‡ßÉ‡¶§‡ßç‡¶§ ‡¶ó‡¶§‡¶ø', classMode: [], statuses: {} },
        { title: '9. ‡¶§‡¶∞‡¶ô‡ßç‡¶ó', classMode: [], statuses: {} },
        { title: '10. ‡¶Ü‡¶¶‡¶∞‡ßç‡¶∂ ‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏ ‡¶ì ‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ó‡¶§‡¶ø‡¶§‡¶§‡ßç‡¶§', classMode: [], statuses: {} }
      ],
      'Physics 2nd': [
        { title: '1. ‡¶§‡¶æ‡¶™‡¶ó‡¶§‡¶ø‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ', classMode: [], statuses: {} },
        { title: '2. ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶§‡ßú‡¶ø‡¶§', classMode: [], statuses: {} },
        { title: '3. ‡¶ö‡¶≤ ‡¶§‡ßú‡¶ø‡¶§', classMode: [], statuses: {} },
        { title: '4. ‡¶§‡ßú‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡¶¨‡¶æ‡¶π‡ßá‡¶∞ ‡¶ö‡ßå‡¶Æ‡ßç‡¶¨‡¶ï ‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶æ', classMode: [], statuses: {} },
        { title: '5. ‡¶§‡ßú‡¶ø‡¶§‡¶ö‡ßå‡¶Æ‡ßç‡¶¨‡¶ï‡ßÄ‡ßü ‡¶Ü‡¶¨‡ßá‡¶∂', classMode: [], statuses: {} },
        { title: '6. ‡¶ú‡ßç‡¶Ø‡¶æ‡¶Æ‡¶ø‡¶§‡¶ø‡¶ï ‡¶Ü‡¶≤‡ßã‡¶ï‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®', classMode: [], statuses: {} },
        { title: '7. ‡¶≠‡ßå‡¶§ ‡¶Ü‡¶≤‡ßã‡¶ï‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®', classMode: [], statuses: {} },
        { title: '8. ‡¶™‡¶∞‡¶Æ‡¶æ‡¶£‡ßÅ‡¶∞ ‡¶Æ‡¶°‡ßá‡¶≤', classMode: [], statuses: {} },
        { title: '9. ‡¶∏‡ßá‡¶Æ‡¶ø‡¶ï‡¶®‡ßç‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡¶∞ ‡¶ì ‡¶á‡¶≤‡ßá‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏', classMode: [], statuses: {} }
      ],
      'Chemistry 1st': [
        { title: '1. ‡¶≤‡ßç‡¶Ø‡¶æ‡¶¨‡¶∞‡ßá‡¶ü‡¶∞‡¶ø‡¶∞ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞', classMode: [], statuses: {} },
        { title: '2. ‡¶ó‡ßÅ‡¶£‡¶ó‡¶§ ‡¶∞‡¶∏‡¶æ‡ßü‡¶®', classMode: [], statuses: {} },
        { title: '3. ‡¶Æ‡ßå‡¶≤‡ßá‡¶∞ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡ßü‡¶¨‡ßÉ‡¶§‡ßç‡¶§ ‡¶ß‡¶∞‡ßç‡¶Æ ‡¶ì ‡¶∞‡¶æ‡¶∏‡¶æ‡ßü‡¶®‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶ß‡¶®', classMode: [], statuses: {} },
        { title: '4. ‡¶∞‡¶æ‡¶∏‡¶æ‡ßü‡¶®‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®', classMode: [], statuses: {} },
        { title: '5. ‡¶ï‡¶∞‡ßç‡¶Æ‡¶Æ‡ßÅ‡¶ñ‡ßÄ ‡¶∞‡¶∏‡¶æ‡ßü‡¶®', classMode: [], statuses: {} }
      ],
      'Chemistry 2nd': [
        { title: '1. ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂ ‡¶∞‡¶∏‡¶æ‡ßü‡¶®', classMode: [], statuses: {} },
        { title: '2. ‡¶ú‡ßà‡¶¨ ‡¶∞‡¶∏‡¶æ‡ßü‡¶®', classMode: [], statuses: {} },
        { title: '3. ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£‡¶ó‡¶§ ‡¶∞‡¶∏‡¶æ‡ßün', classMode: [], statuses: {} },
        { title: '4. ‡¶§‡ßú‡¶ø‡ßé ‡¶∞‡¶∏‡¶æ‡ßü‡¶®', classMode: [], statuses: {} },
        { title: '5. ‡¶Ö‡¶∞‡ßç‡¶•‡¶®‡ßà‡¶§‡¶ø‡¶ï ‡¶∞‡¶∏‡¶æ‡ßü‡¶®', classMode: [], statuses: {} }
      ],
      'Higher Math 1st': [
        { title: '1. ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßç‡¶∞‡¶ø‡¶ï‡ßç‡¶∏', classMode: [], statuses: {} },
        { title: '2. ‡¶≠‡ßá‡¶ï‡ßç‡¶ü‡¶∞', classMode: [], statuses: {} },
        { title: '3. ‡¶∏‡¶∞‡¶≤‡¶∞‡ßá‡¶ñ‡¶æ', classMode: [], statuses: {} },
        { title: '4. ‡¶¨‡ßÉ‡¶§‡ßç‡¶§', classMode: [], statuses: {} },
        { title: '5. ‡¶¨‡¶ø‡¶®‡ßç‡¶Ø‡¶æ‡¶∏', classMode: [], statuses: {} },
        { title: '6. ‡¶§‡ßç‡¶∞‡¶ø‡¶ï‡ßã‡¶£‡ßç‡¶Æ‡¶ø‡¶§‡¶ø‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶™‡¶æ‡¶§', classMode: [], statuses: {} },
        { title: '7. ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ì ‡¶Ø‡ßå‡¶ó‡¶ø‡¶ï ‡¶ï‡ßã‡¶£‡ßá‡¶∞ ‡¶§‡ßç‡¶∞‡¶ø‡¶ï‡ßã‡¶£‡¶Æ‡¶ø‡¶§‡¶ø‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶™‡¶æ‡¶§', classMode: [], statuses: {} },
        { title: '8. ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®', classMode: [], statuses: {} },
        { title: '9. ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßÄ‡¶ï‡¶∞‡¶£', classMode: [], statuses: {} },
        { title: '10. ‡¶Ø‡ßã‡¶ó‡¶ú‡ßÄ‡¶ï‡¶∞‡¶£', classMode: [], statuses: {} }
      ],
      'Higher Math 2nd': [
        { title: '1. ‡¶¨‡¶æ‡¶∏‡ßç‡¶§‡¶¨ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ', classMode: [], statuses: {} },
        { title: '2. ‡¶Ø‡ßã‡¶ó‡¶æ‡¶∂‡ßç‡¶∞‡ßü‡ßÄ ‡¶™‡ßç‡¶∞‡ßã‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ', classMode: [], statuses: {} },
        { title: '3. ‡¶ú‡¶ü‡¶ø‡¶≤ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ', classMode: [], statuses: {} },
        { title: '4. ‡¶¨‡¶π‡ßÅ‡¶™‡¶¶‡ßÄ', classMode: [], statuses: {} },
        { title: '5. ‡¶¶‡ßç‡¶¨‡¶ø‡¶™‡¶¶‡ßÄ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶§‡¶ø', classMode: [], statuses: {} },
        { title: '6. ‡¶ï‡¶®‡¶ø‡¶ï', classMode: [], statuses: {} },
        { title: '7. ‡¶¨‡¶ø‡¶™‡¶∞‡ßÄ‡¶§ ‡¶§‡ßç‡¶∞‡¶ø‡¶ï‡ßã‡¶£‡¶Æ‡¶ø‡¶§‡¶ø‡¶ï ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®', classMode: [], statuses: {} },
        { title: '8. ‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ', classMode: [], statuses: {} },
        { title: '9. ‡¶∏‡¶Æ‡¶§‡¶≤‡ßá ‡¶¨‡¶∏‡ßç‡¶§‡ßÅ‡¶ï‡¶£‡¶æ‡¶∞ ‡¶ó‡¶§‡¶ø', classMode: [], statuses: {} },
        { title: '10. ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™ ‡¶ì ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡¶®‡¶æ', classMode: [], statuses: {} }
      ],
      'Biology 1st': [
        { title: '1. ‡¶ï‡ßã‡¶∑ ‡¶ì ‡¶è‡¶∞ ‡¶ó‡¶†‡¶®', classMode: [], statuses: {} },
        { title: '2. ‡¶ï‡ßã‡¶∑ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ú‡¶®', classMode: [], statuses: {} },
        { title: '3. ‡¶ï‡ßã‡¶∑ ‡¶∞‡¶∏‡¶æ‡ßü‡¶®', classMode: [], statuses: {} },
        { title: '4. ‡¶Ö‡¶£‡ßÅ‡¶ú‡ßÄ‡¶¨', classMode: [], statuses: {} },
        { title: '5. ‡¶∂‡ßà‡¶¨‡¶æ‡¶≤ ‡¶ì ‡¶õ‡¶§‡ßç‡¶∞‡¶æ‡¶ï', classMode: [], statuses: {} },
        { title: '6. ‡¶¨‡ßç‡¶∞‡¶æ‡ßü‡ßã‡¶´‡¶æ‡¶á‡¶ü‡¶æ ‡¶ì ‡¶ü‡ßá‡¶∞‡¶ø‡¶°‡ßã‡¶´‡¶æ‡¶á‡¶ü‡¶æ', classMode: [], statuses: {} },
        { title: '7. ‡¶®‡¶ó‡ßç‡¶®‡¶¨‡ßÄ‡¶ú‡ßÄ ‡¶ì ‡¶Ü‡¶¨‡ßÉ‡¶ì‡¶§‡¶¨‡ßÄ‡¶ú‡ßÄ ‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶', classMode: [], statuses: {} },
        { title: '8. ‡¶ü‡¶ø‡¶∏‡ßç‡¶Ø‡ßÅ ‡¶ì ‡¶ü‡¶ø‡¶∏‡ßç‡¶Ø‡ßÅ‡¶§‡¶®‡ßç‡¶§‡ßç‡¶∞', classMode: [], statuses: {} },
        { title: '9. ‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶‡ßá‡¶∞ ‡¶∂‡¶æ‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨', classMode: [], statuses: {} },
        { title: '10. ‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶ú‡¶®‡¶®', classMode: [], statuses: {} },
        { title: '11. ‡¶ú‡ßÄ‡¶¨‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø', classMode: [], statuses: {} },
        { title: '12. ‡¶ú‡ßÄ‡¶¨‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂, ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞ ‡¶ì ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£', classMode: [], statuses: {} }
      ],
      'Biology 2nd': [
        { title: '1. ‡¶™‡ßç‡¶∞‡¶æ‡¶£‡ßÄ‡¶∞ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø‡¶¨‡¶ø‡¶®‡ßç‡¶Ø‡¶æ‡¶∏', classMode: [], statuses: {} },
        { title: '2. ‡¶™‡ßç‡¶∞‡¶æ‡¶£‡ßÄ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø', classMode: [], statuses: {} },
        { title: '3. ‡¶™‡¶∞‡¶ø‡¶™‡¶æ‡¶ï ‡¶ì ‡¶∂‡ßã‡¶∑‡¶£', classMode: [], statuses: {} },
        { title: '4. ‡¶∞‡¶ï‡ßç‡¶§ ‡¶ì ‡¶∏‡¶û‡ßç‡¶ö‡¶æ‡¶≤‡¶®', classMode: [], statuses: {} },
        { title: '5. ‡¶∂‡ßç‡¶¨‡¶∏‡¶® ‡¶ì ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶æ', classMode: [], statuses: {} },
        { title: '6. ‡¶¨‡¶∞‡ßç‡¶ú‡ßç‡¶Ø ‡¶ì ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∂‡¶®', classMode: [], statuses: {} },
        { title: '7. ‡¶ö‡¶≤‡¶® ‡¶ì ‡¶Ü‡¶ô‡ßç‡¶ó‡¶ö‡¶æ‡¶≤‡¶®‡¶æ', classMode: [], statuses: {} },
        { title: '8. ‡¶∏‡¶Æ‡¶®‡ßç‡¶¨‡ßü ‡¶ì ‡¶®‡¶ø‡ßü‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£', classMode: [], statuses: {} },
        { title: '9. ‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶ú‡ßÄ‡¶¨‡¶®‡ßá‡¶∞ ‡¶ß‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶ø‡¶ï‡¶§‡¶æ', classMode: [], statuses: {} },
        { title: '10. ‡¶Æ‡¶æ‡¶®‡¶¨‡¶¶‡ßá‡¶π‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∞‡¶ï‡ßç‡¶∑‡¶æ', classMode: [], statuses: {} },
        { title: '11. ‡¶ú‡¶ø‡¶®‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨ ‡¶ì ‡¶¨‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®', classMode: [], statuses: {} },
        { title: '12. ‡¶™‡ßç‡¶∞‡¶æ‡¶£‡ßÄ‡¶∞ ‡¶Ü‡¶ö‡¶∞‡¶£', classMode: [], statuses: {} }
      ],
      'ICT': [
        { title: '1. ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨ ‡¶ì ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶™‡ßç‡¶∞‡ßá‡¶ï‡ßç‡¶∑‡¶ø‡¶§', classMode: [], statuses: {} },
        { title: '2. ‡¶ï‡¶Æ‡¶ø‡¶â‡¶®‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡¶∏ ‡¶ì ‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï‡¶ø‡¶Ç', classMode: [], statuses: {} },
        { title: '3. ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø', classMode: [], statuses: {} },
        { title: '4. ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏', classMode: [], statuses: {} },
        { title: '5. ‡¶ì‡ßü‡ßá‡¶¨ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø', classMode: [], statuses: {} },
        { title: '6. ‡¶™‡ßç‡¶∞‡ßã‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡¶ø‡¶Ç ‡¶≠‡¶æ‡¶∑‡¶æ', classMode: [], statuses: {} },
        { title: '7. ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ', classMode: [], statuses: {} }
      ]
    };
    let currentSubject = subjects[0];
    let lastRenderedSubject = null;
    let lastChapterCount = 0;

    // --- Firebase Setup ---
    const firebaseConfig = {
      apiKey: "AIzaSyAx3b-2EPm2qPjYu6L07GCCKAkoF_z1sF0",
      authDomain: "poralagbe-17c0e.firebaseapp.com",
      databaseURL: "https://poralagbe-17c0e-default-rtdb.firebaseio.com",
      projectId: "poralagbe-17c0e",
      storageBucket: "poralagbe-17c0e.firebasestorage.app",
      messagingSenderId: "380156491503",
      appId: "1:380156491503:web:9983033564385f0b5d8d1a"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let firebaseUserId = null;
    let firebaseLoaded = false;
    let firebaseWritePending = false;

    // Sign in anonymously and load data
    auth.signInAnonymously().then(userCred => {
      firebaseUserId = userCred.user.uid;
      // Listen for changes in user's data
      db.ref('users/' + firebaseUserId).on('value', snapshot => {
        const data = snapshot.val();
        if (data) {
          state = data.state || state;
          statusConfig = data.statusConfig || statusConfig;
          // Ensure all subjects exist
          subjects.forEach(sub => {
            state[sub] = state[sub] || [];
            statusConfig[sub] = statusConfig[sub] || [];
          });
        } else {
          // First time: initialize
          subjects.forEach(sub => {
            state[sub] = state[sub] || [];
            statusConfig[sub] = statusConfig[sub] || [];
          });
        }
        firebaseLoaded = true;
        render();
      });
    }).catch(e => {
      showToast('error', 'Firebase auth failed');
    });

    // Save state/statusConfig to Firebase (debounced)
    function saveStateToFirebase() {
      if (!firebaseUserId) return;
      if (!firebaseLoaded) return;
      if (firebaseWritePending) return;
      firebaseWritePending = true;
      setTimeout(() => {
        db.ref('users/' + firebaseUserId).set({
          state,
          statusConfig
        }).then(() => {
          firebaseWritePending = false;
          renderProgressBar();
        }).catch(() => {
          firebaseWritePending = false;
          showToast('error', 'Failed to save to Firebase');
        });
      }, 200);
    }

    // Replace saveState with Firebase version
    const saveState = saveStateToFirebase;

    // Remove all localStorage usage for state/statusConfig
    // Only keep currentSubject and theme in localStorage

    // Load currentSubject from localStorage
    try {
      currentSubject = localStorage.getItem('currentSubject') || subjects[0];
    } catch (e) {
      showToast('error', 'Failed to load current subject from localStorage.');
    }

    // Debounce saveState to avoid excessive localStorage writes
    let saveTimeout;
    const saveStateDebounced = () => {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        try {
          localStorage.setItem('studyState', JSON.stringify(state));
          localStorage.setItem('statusConfig', JSON.stringify(statusConfig));
          renderProgressBar();
        } catch (e) {
          showToast('error', 'Failed to save data to localStorage. It may be full or disabled.');
        }
      }, 200);
    };

    const saveNav = () => {
      try {
        localStorage.setItem('currentSubject', currentSubject);
      } catch (e) {
        showToast('error', 'Failed to save current subject to localStorage.');
      }
    };

    function toggleSidebar() {
      document.getElementById('mobileSidebar').classList.toggle('-translate-x-full');
      document.getElementById('overlay').classList.toggle('hidden');
    }

    // Helper for toast
    function showToast(icon, title) {
      Swal.fire({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 1200,
        icon,
        title,
        timerProgressBar: true
      });
    }

    // Theme toggle
    let isDark = true;
    try {
      isDark = localStorage.getItem('theme') !== 'light';
    } catch (e) {
      showToast('error', 'Failed to load theme from localStorage.');
    }
    function applyTheme() {
      document.body.classList.toggle('bg-gray-900', isDark);
      document.body.classList.toggle('text-gray-100', isDark);
      document.body.classList.toggle('bg-white', !isDark);
      document.body.classList.toggle('text-gray-900', !isDark);
    }
    applyTheme();

    // Tools Dropdown Toggle
    document.getElementById('toolsBtn').onclick = (e) => {
      e.preventDefault();
      const dropdown = document.getElementById('toolsDropdown');
      dropdown.classList.toggle('hidden');
    };

    // Export
    document.getElementById('exportBtn').onclick = () => {
      const dataStr = JSON.stringify({ state, statusConfig }, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'study-progress.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      showToast('success', 'Exported!');
      document.getElementById('toolsDropdown').classList.add('hidden');
    };

    // Import
    document.getElementById('importBtn').onclick = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const imported = JSON.parse(text);
          if (typeof imported === 'object' && imported.state && imported.statusConfig) {
            state = imported.state;
            statusConfig = imported.statusConfig;
            subjects.forEach(sub => {
              state[sub] = state[sub] || [];
              statusConfig[sub] = statusConfig[sub] || [];
            });
            saveState();
            render();
            showToast('success', 'Imported!');
          } else {
            showToast('error', 'Invalid file');
          }
        } catch {
          showToast('error', 'Import failed');
        }
      };
      input.click();
      document.getElementById('toolsDropdown').classList.add('hidden');
    };

    // Theme Toggle
    document.getElementById('themeToggleBtn').onclick = () => {
      isDark = !isDark;
      try {
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      } catch (e) {
        showToast('error', 'Failed to save theme to localStorage.');
      }
      applyTheme();
      showToast('success', isDark ? 'Dark mode' : 'Light mode');
      document.getElementById('toolsDropdown').classList.add('hidden');
    };

    // Clear All Data
    document.getElementById('clearAllBtn').onclick = async () => {
      const result = await Swal.fire({
        title: 'Clear All Data',
        text: 'This will delete all subjects, chapters, and statuses. Are you sure?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, clear all',
        cancelButtonText: 'Cancel'
      });
      if (result.isConfirmed) {
        try {
          // Remove from Firebase
          await db.ref('users/' + firebaseUserId).remove();
          state = {};
          statusConfig = {};
          subjects.forEach(sub => {
            state[sub] = state[sub] || [];
            statusConfig[sub] = statusConfig[sub] || [];
          });
          currentSubject = subjects[0] || '';
          render();
          showToast('success', 'All data cleared');
        } catch (e) {
          showToast('error', 'Failed to clear data from Firebase');
        }
      }
      document.getElementById('toolsDropdown').classList.add('hidden');
    };

    // Progress Chart
    document.getElementById('progressChartBtn').onclick = () => {
      const progressData = subjects.map(sub => {
        const chapters = state[sub] || [];
        const statuses = statusConfig[sub] || [];
        const total = chapters.length * statuses.length;
        let done = 0;
        chapters.forEach(ch => {
          statuses.forEach(st => {
            if (ch.statuses[st]) done++;
          });
        });
        const percent = total ? Math.round((done / total) * 100) : 0;
        return { subject: sub, percent };
      });

      Swal.fire({
        title: 'Progress Chart',
        html: '<canvas id="progressChart" width="400" height="200"></canvas>',
        didOpen: () => {
          const ctx = document.getElementById('progressChart').getContext('2d');
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: progressData.map(d => d.subject),
              datasets: [{
                label: 'Completion %',
                data: progressData.map(d => d.percent),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100
                }
              },
              responsive: true,
              maintainAspectRatio: false
            }
          });
        },
        width: '90vw',
        maxWidth: '600px'
      });
      document.getElementById('toolsDropdown').classList.add('hidden');
    };

    // Edit Statuses
    document.getElementById('editStatusesBtn').onclick = async () => {
      const currentStatuses = statusConfig[currentSubject] || [];
      const { value: newStatuses, isConfirmed } = await Swal.fire({
        title: 'Edit Statuses',
        html: `
          <p>Edit statuses for ${currentSubject}. Separate each status with a comma.</p>
          <textarea id="statusInput" class="w-full p-2 bg-gray-800 text-blue-400 rounded" rows="4" placeholder="e.g., New Status 1, New Status 2">${currentStatuses.join(', ')}</textarea>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Save',
        cancelButtonText: 'Cancel',
        preConfirm: () => {
          const input = document.getElementById('statusInput').value.trim();
          if (!input) {
            Swal.showValidationMessage('Please enter at least one status!');
            return false;
          }
          const statuses = input.split(',').map(s => s.trim()).filter(s => s);
          if (statuses.length === 0) {
            Swal.showValidationMessage('Please enter at least one status!');
            return false;
          }
          return statuses;
        }
      });

      if (isConfirmed && newStatuses) {
        // Map old statuses to new ones and initialize any new statuses
        const oldStatuses = currentStatuses;
        statusConfig[currentSubject] = newStatuses;

        // Update statuses in all chapters of the current subject
        state[currentSubject].forEach(ch => {
          const newStatusesObj = {};
          newStatuses.forEach((newSt, idx) => {
            const oldSt = oldStatuses[idx];
            newStatusesObj[newSt] = oldSt ? (ch.statuses[oldSt] || false) : false;
          });
          // Ensure all new statuses are present, even if they exceed old ones
          newStatuses.forEach(newSt => {
            if (!(newSt in newStatusesObj)) newStatusesObj[newSt] = false;
          });
          ch.statuses = newStatusesObj;
        });

        saveState();
        render();
        showToast('success', 'Statuses updated successfully');
      }
      document.getElementById('toolsDropdown').classList.add('hidden');
    };

    // Search with debouncing
    let chapterSearchValue = '';
    let universalSearchValue = '';
    let searchTimeout;
    let universalSearchTimeout;

    document.getElementById('chapterSearch').addEventListener('input', e => {
      clearTimeout(searchTimeout);
      chapterSearchValue = e.target.value.toLowerCase();
      searchTimeout = setTimeout(() => {
        renderChapters();
      }, 300);
    });

    document.getElementById('universalSearch').addEventListener('input', e => {
      clearTimeout(universalSearchTimeout);
      universalSearchValue = e.target.value.toLowerCase();
      universalSearchTimeout = setTimeout(() => {
        performUniversalSearch();
      }, 300);
    });

    function performUniversalSearch() {
      const dropdown = document.getElementById('universalSearchDropdown');
      if (!universalSearchValue) {
        dropdown.classList.add('hidden');
        return;
      }

      const results = [];
      subjects.forEach(sub => {
        state[sub].forEach((ch, idx) => {
          if (ch.title.toLowerCase().includes(universalSearchValue)) {
            results.push({ subject: sub, chapter: ch, index: idx });
          }
        });
      });

      dropdown.innerHTML = '';
      if (results.length > 0) {
        results.slice(0, 10).forEach(result => {
          const item = document.createElement('div');
          item.textContent = `${result.subject} - ${result.chapter.title}`;
          item.className = 'px-4 py-2 text-xs hover:bg-blue-900 cursor-pointer bangla-text';
          item.onclick = () => {
            currentSubject = result.subject;
            saveNav();
            render();
            document.getElementById('chapterContainer').scrollTo(0, result.index * 200); // Approximate scroll to chapter
            dropdown.classList.add('hidden');
            document.getElementById('universalSearch').value = '';
          };
          dropdown.appendChild(item);
        });
        dropdown.classList.remove('hidden');
      } else {
        dropdown.classList.add('hidden');
      }
    }

    // Progress bar with responsive design
    function renderProgressBar() {
      const wrapper = document.getElementById('progressBarWrapper');
      const chapters = state[currentSubject];
      const statuses = statusConfig[currentSubject] || [];
      let total = chapters.length * statuses.length;
      let done = 0;
      chapters.forEach(ch => {
        statuses.forEach(st => {
          if (ch.statuses[st]) done++;
        });
      });
      let percent = total ? Math.round((done / total) * 100) : 0;
      wrapper.innerHTML = `
        <div class="mb-2 flex items-center justify-between w-full">
          <span class="text-xs sm:text-base text-blue-400 font-semibold">Progress: ${percent}%</span>
          <span class="text-xs sm:text-sm text-gray-400 hidden sm:inline">${done}/${total} completed</span>
        </div>
        <div class="w-full h-2 sm:h-3 bg-gray-800 rounded-full">
          <div class="h-2 sm:h-3 rounded-full bg-blue-500 transition-all" style="width:${percent}%;"></div>
        </div>
      `;
    }

    document.getElementById('addChapterBtn').onclick = async () => {
      const { value: title, isConfirmed } = await Swal.fire({
        title: 'Add Chapter',
        input: 'text',
        inputLabel: 'Enter new chapter title:',
        inputPlaceholder: 'Chapter title',
        showCancelButton: true,
        confirmButtonText: 'Add',
        cancelButtonText: 'Cancel',
        inputValidator: (value) => {
          if (!value) return 'Please enter a chapter title!';
          if (state[currentSubject].some(ch => ch.title.toLowerCase() === value.toLowerCase())) {
            return 'Chapter title already exists in this subject!';
          }
        }
      });
      if (isConfirmed && title) {
        state[currentSubject].push({ title, classMode: [], statuses: {} });
        // Initialize chapter statuses with current subject statuses
        state[currentSubject][state[currentSubject].length - 1].statuses = Object.fromEntries(
          statusConfig[currentSubject].map(st => [st, false])
        );
        saveState();
        render();
        showToast('success', 'Added successfully');
      } else if (isConfirmed && !title) {
        showToast('error', 'Failed to add');
      }
    };

    function renderSubjects() {
      if (lastRenderedSubject === currentSubject) return;
      lastRenderedSubject = currentSubject;
      const deskNav = document.getElementById('subjectNav');
      deskNav.innerHTML = '';
      const mobNav = document.querySelector('#mobileSidebar nav');
      mobNav.innerHTML = '';
      subjects.forEach((sub, index) => {
        const createBtn = () => {
          const b = document.createElement('button');
          b.textContent = sub;
          b.className = `px-3 sm:px-4 py-1 sm:py-2 rounded-full text-xs sm:text-sm font-semibold shadow transition ${sub === currentSubject ? 'bg-blue-500 text-white' : 'bg-gray-800 text-blue-400 border border-gray-700'} hover:bg-blue-900 hover:text-blue-200 focus:outline-blue-400`;
          b.setAttribute('tabindex', '0');
          b.onclick = () => { currentSubject = sub; saveNav(); render(); if (window.innerWidth < 640) toggleSidebar(); };
          b.onkeydown = (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              b.click();
            }
          };
          return b;
        };
        deskNav.appendChild(createBtn());
        mobNav.appendChild(createBtn());
      });
    }

    function createDropdown(ch) {
      const wrapper = document.createElement('div');
      wrapper.className = 'relative mb-2 w-full';
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'w-full text-left bg-gray-800 text-blue-400 p-2 rounded focus:outline-blue-400 transition shadow hover:bg-blue-900';
      btn.setAttribute('aria-haspopup', 'listbox');
      btn.setAttribute('aria-label', 'Select Class Mode');
      btn.textContent = ch.classMode.length ? ch.classMode.join(', ') : 'Select Class Mode';
      const menu = document.createElement('div');
      menu.className = 'absolute left-0 mt-1 w-full bg-gray-900 border border-blue-700 rounded shadow-lg hidden z-10 max-h-40 overflow-y-auto transition';
      menu.setAttribute('role', 'listbox');
      classOptions.forEach(opt => {
        const item = document.createElement('label');
        item.className = 'flex items-center px-2 py-1 hover:bg-blue-900 cursor-pointer rounded transition';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'mr-2 accent-blue-400';
        cb.checked = ch.classMode.includes(opt);
        cb.onchange = () => {
          if (cb.checked) ch.classMode.push(opt);
          else ch.classMode = ch.classMode.filter(x => x !== opt);
          btn.textContent = ch.classMode.length ? ch.classMode.join(', ') : 'Select Class Mode';
          saveState();
        };
        item.append(cb, document.createTextNode(opt));
        menu.appendChild(item);
      });
      btn.onclick = e => {
        e.stopPropagation();
        menu.classList.toggle('hidden');
        btn.classList.toggle('ring-2');
      };
      btn.onkeydown = e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          menu.classList.toggle('hidden');
          btn.classList.toggle('ring-2');
          if (!menu.classList.contains('hidden')) menu.querySelector('input').focus();
        }
      };
      menu.onkeydown = e => {
        const inputs = Array.from(menu.querySelectorAll('input'));
        const currentIdx = inputs.indexOf(document.activeElement);
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          inputs[(currentIdx + 1) % inputs.length].focus();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          inputs[(currentIdx - 1 + inputs.length) % inputs.length].focus();
        } else if (e.key === 'Escape') {
          menu.classList.add('hidden');
          btn.classList.remove('ring-2');
          btn.focus();
        }
      };
      document.addEventListener('click', e => {
        if (!wrapper.contains(e.target)) {
          menu.classList.add('hidden');
          btn.classList.remove('ring-2');
        }
      });
      wrapper.append(btn, menu);
      return wrapper;
    }

    function renderChapters() {
      const cont = document.getElementById('chapterContainer');
      const chapters = state[currentSubject];
      if (chapters.length === lastChapterCount && chapterSearchValue === '') return;
      lastChapterCount = chapters.length;
      cont.innerHTML = '';
      renderProgressBar();
      const statuses = statusConfig[currentSubject] || [];
      const filteredChapters = chapterSearchValue
        ? chapters.filter(ch => ch.title.toLowerCase().includes(chapterSearchValue))
        : chapters;
      filteredChapters.forEach((ch, i) => {
        const card = document.createElement('div');
        card.className = 'bg-gray-900 p-4 sm:p-6 rounded-xl shadow border border-gray-800 flex flex-col transition hover:scale-[1.02] focus-within:ring-2 ring-blue-400 w-full min-w-0';
        card.tabIndex = 0;
        card.onkeydown = e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            card.click();
          }
        };
        if (window.innerWidth < 640) {
          card.classList.add('cursor-pointer');
          card.onclick = () => {
            ch._expanded = !ch._expanded;
            renderChapters();
          };
          if (!ch._expanded) {
            card.innerHTML = `<div class="text-blue-400 font-bold text-sm sm:text-base bangla-text">${ch.title}</div>`;
            cont.append(card);
            return;
          }
        }
        const hd = document.createElement('div');
        hd.className = 'flex flex-col mb-4 gap-2';
        const title = document.createElement('h3');
        title.textContent = ch.title; // Use pre-numbered title
        title.className = 'text-lg sm:text-xl font-bold break-words text-blue-400 mb-2 bangla-text';
        const btnGroup = document.createElement('div');
        btnGroup.className = 'flex gap-1 flex-wrap';
        const editBtn = document.createElement('button');
        editBtn.textContent = '‚úèÔ∏è';
        editBtn.className = 'ml-2 px-2 py-1 rounded hover:bg-gray-800 focus:outline-blue-400 transition';
        editBtn.setAttribute('aria-label', 'Edit chapter title');
        editBtn.onclick = async () => {
          const { value: t, isConfirmed } = await Swal.fire({
            title: 'Edit Chapter',
            input: 'text',
            inputLabel: 'Edit title:',
            inputValue: ch.title.replace(/^\d+\.\s*/, ''), // Remove number for editing
            showCancelButton: true,
            confirmButtonText: 'Save',
            cancelButtonText: 'Cancel',
            inputValidator: (value) => {
              if (!value) return 'Please enter a chapter title!';
              if (state[currentSubject].some(c => c.title.toLowerCase() === (i + 1 + '. ' + value).toLowerCase() && c !== ch)) {
                return 'Chapter title already exists in this subject!';
              }
            }
          });
          if (isConfirmed && t) {
            ch.title = (i + 1) + '. ' + t; // Reapply number
            saveState();
            render();
            showToast('success', 'Edited successfully');
          } else if (isConfirmed && !t) {
            showToast('error', 'Failed to edit');
          }
        };
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.className = 'ml-2 px-2 py-1 rounded hover:bg-red-900 focus:outline-red-400 transition';
        delBtn.setAttribute('aria-label', 'Delete chapter');
        delBtn.onclick = async () => {
          const result = await Swal.fire({
            title: 'Delete Chapter',
            text: 'Are you sure you want to delete this chapter?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Delete',
            cancelButtonText: 'Cancel'
          });
          if (result.isConfirmed) {
            chapters.splice(i, 1);
            saveState();
            render();
            showToast('success', 'Deleted successfully');
          } else if (result.dismiss === Swal.DismissReason.cancel) {
            showToast('error', 'Delete cancelled');
          }
        };
        const notesBtn = document.createElement('button');
        notesBtn.textContent = 'üìù';
        notesBtn.className = 'ml-2 px-2 py-1 rounded hover:bg-gray-800 focus:outline-blue-400 transition';
        notesBtn.setAttribute('aria-label', 'Edit notes');
        notesBtn.onclick = async () => {
          const { value: note, isConfirmed } = await Swal.fire({
            title: 'Chapter Notes',
            input: 'textarea',
            inputLabel: 'Add/Edit notes for this chapter:',
            inputValue: ch.notes || '',
            showCancelButton: true,
            confirmButtonText: 'Save',
            cancelButtonText: 'Cancel'
          });
          if (isConfirmed) {
            ch.notes = note;
            saveState();
            showToast('success', 'Notes saved');
          }
        };
        const deadlineBtn = document.createElement('button');
        deadlineBtn.textContent = '‚è∞';
        deadlineBtn.className = 'ml-2 px-2 py-1 rounded hover:bg-gray-800 focus:outline-blue-400 transition';
        deadlineBtn.setAttribute('aria-label', 'Set deadline');
        deadlineBtn.onclick = async () => {
          const { value: date, isConfirmed } = await Swal.fire({
            title: 'Set Deadline',
            input: 'date',
            inputLabel: 'Pick a deadline for this chapter:',
            inputValue: ch.deadline || '',
            showCancelButton: true,
            confirmButtonText: 'Save',
            cancelButtonText: 'Cancel'
          });
          if (isConfirmed) {
            ch.deadline = date;
            saveState();
            showToast('success', 'Deadline saved');
            render();
          }
        };
        const upBtn = document.createElement('button');
        upBtn.textContent = '‚¨ÜÔ∏è';
        upBtn.className = 'ml-2 px-2 py-1 rounded hover:bg-gray-800 focus:outline-blue-400 transition';
        upBtn.setAttribute('aria-label', 'Move chapter up');
        upBtn.disabled = i === 0;
        upBtn.onclick = () => {
          if (i > 0) {
            [filteredChapters[i - 1], filteredChapters[i]] = [filteredChapters[i], filteredChapters[i - 1]];
            saveState();
            render();
          }
        };
        const downBtn = document.createElement('button');
        downBtn.textContent = '‚¨áÔ∏è';
        downBtn.className = 'ml-2 px-2 py-1 rounded hover:bg-gray-800 focus:outline-blue-400 transition';
        downBtn.setAttribute('aria-label', 'Move chapter down');
        downBtn.disabled = i === filteredChapters.length - 1;
        downBtn.onclick = () => {
          if (i < filteredChapters.length - 1) {
            [filteredChapters[i + 1], filteredChapters[i]] = [filteredChapters[i], filteredChapters[i + 1]];
            saveState();
            render();
          }
        };
        btnGroup.append(editBtn, delBtn, notesBtn, deadlineBtn, upBtn, downBtn);
        hd.append(title, btnGroup);
        card.append(hd);
        if (ch.deadline) {
          const deadlineDiv = document.createElement('div');
          deadlineDiv.className = 'text-xs text-red-400 mb-2';
          deadlineDiv.textContent = `Deadline: ${ch.deadline}`;
          card.append(deadlineDiv);
        }
        card.append(createDropdown(ch));
        statuses.forEach(st => {
          const row = document.createElement('div');
          row.className = 'flex justify-between items-center py-1';
          const lbl = document.createElement('span');
          lbl.textContent = st;
          lbl.className = 'text-blue-400 font-medium text-sm sm:text-base';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = ch.statuses[st] || false;
          cb.className = 'accent-blue-400 focus:outline-blue-400 scale-125 transition';
          cb.setAttribute('aria-label', `Mark ${st} as complete`);
          cb.onchange = () => {
            ch.statuses[st] = cb.checked;
            saveState();
            renderProgressBar();
          };
          row.append(lbl, cb);
          card.append(row);
        });
        if (ch.notes) {
          const notesDiv = document.createElement('div');
          notesDiv.className = 'mt-2 text-xs text-gray-400 whitespace-pre-line';
          notesDiv.textContent = `Notes: ${ch.notes}`;
          card.append(notesDiv);
        }
        cont.append(card);
      });
    }

    function render() {
      renderSubjects();
      renderChapters();
    }
    render();

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      const toolsDropdown = document.getElementById('toolsDropdown');
      const toolsBtn = document.getElementById('toolsBtn');
      if (!toolsBtn.contains(e.target) && !toolsDropdown.contains(e.target)) {
        toolsDropdown.classList.add('hidden');
      }
      const universalDropdown = document.getElementById('universalSearchDropdown');
      const universalSearch = document.getElementById('universalSearch');
      if (!universalSearch.contains(e.target) && !universalDropdown.contains(e.target)) {
        universalDropdown.classList.add('hidden');
      }
    });
  </script>
</body>
</html>